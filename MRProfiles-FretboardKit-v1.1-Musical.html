<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MRProfiles + FretboardKit v1.1 - Musical Output</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', -apple-system, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: rgba(255,255,255,0.95);
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .version-badge {
            display: inline-block;
            background: #ff6b6b;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 14px;
            margin-left: 10px;
        }
        
        .stats {
            display: flex;
            gap: 30px;
            color: #666;
            font-size: 14px;
        }
        
        .main-container {
            display: flex;
            flex: 1;
            max-width: 1400px;
            margin: 20px auto;
            width: 100%;
            gap: 20px;
            padding: 0 20px;
        }
        
        .sidebar {
            width: 350px;
            background: rgba(255,255,255,0.95);
            border-radius: 10px;
            padding: 20px;
            max-height: calc(100vh - 140px);
            overflow-y: auto;
        }
        
        .content-area {
            flex: 1;
            background: rgba(255,255,255,0.95);
            border-radius: 10px;
            padding: 20px;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .action-btn:hover {
            background: #764ba2;
        }
        
        .action-btn.play {
            background: #28a745;
        }
        
        .action-btn.play:hover {
            background: #218838;
        }
        
        .output-box {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }
        
        .output-box.visible {
            display: block;
        }
        
        #fretboard {
            width: 100%;
            height: 300px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            background: white;
        }
        
        .tempo-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }
        
        .tempo-control input {
            width: 200px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üé∏ MRProfiles + FretboardKit <span class="version-badge">v1.1 Musical</span></h1>
        <div class="stats">
            <span>üéµ Produces Real Music</span>
            <span>üéº MusicXML Export</span>
            <span>üéπ MIDI Export</span>
            <span>üîä Audio Playback</span>
        </div>
    </div>
    
    <div class="main-container">
        <div class="sidebar">
            <h3>Select a Profile:</h3>
            <select id="profileSelect" style="width: 100%; padding: 8px; margin: 10px 0;">
                <option value="">-- Choose Profile --</option>
                <optgroup label="Jazz Guitar">
                    <option value="wes-montgomery">Wes Montgomery</option>
                    <option value="jim-hall">Jim Hall</option>
                    <option value="joe-pass">Joe Pass</option>
                </optgroup>
                <optgroup label="Greek & Rebetiko">
                    <option value="rebetiko">Greek Rebetiko</option>
                    <option value="tsitsanis">Vassilis Tsitsanis</option>
                </optgroup>
                <optgroup label="Alternative Tunings">
                    <option value="sonic-youth">Sonic Youth</option>
                    <option value="joni-mitchell">Joni Mitchell</option>
                </optgroup>
                <optgroup label="Techniques">
                    <option value="travis-picking">Travis Picking</option>
                    <option value="boom-chuck">Boom-Chuck</option>
                </optgroup>
            </select>
            
            <div class="tempo-control">
                <label>Tempo:</label>
                <input type="range" id="tempo" min="60" max="200" value="120">
                <span id="tempoValue">120 BPM</span>
            </div>
            
            <div class="tempo-control">
                <label>Key:</label>
                <select id="keySelect" style="padding: 5px;">
                    <option value="0">C</option>
                    <option value="1">C#/Db</option>
                    <option value="2">D</option>
                    <option value="3">D#/Eb</option>
                    <option value="4">E</option>
                    <option value="5">F</option>
                    <option value="6">F#/Gb</option>
                    <option value="7">G</option>
                    <option value="8">G#/Ab</option>
                    <option value="9">A</option>
                    <option value="10">A#/Bb</option>
                    <option value="11">B</option>
                </select>
            </div>
            
            <div id="profileInfo" style="margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 5px;">
                <p>Select a profile to generate music</p>
            </div>
        </div>
        
        <div class="content-area">
            <h2 id="profileName">No Profile Selected</h2>
            
            <div class="action-buttons">
                <button class="action-btn play" id="playPattern">‚ñ∂Ô∏è Play Pattern</button>
                <button class="action-btn play" id="stopPattern">‚èπÔ∏è Stop</button>
                <button class="action-btn" id="exportMusicXML">üìÑ Export MusicXML</button>
                <button class="action-btn" id="exportMIDI">üéπ Export MIDI</button>
                <button class="action-btn" id="exportAudio">üîä Export Audio (WAV)</button>
                <button class="action-btn" id="exportRiffGen">‚Üí To RiffGen</button>
            </div>
            
            <svg id="fretboard" viewBox="0 0 1000 300">
                <!-- Fretboard will be drawn here -->
            </svg>
            
            <div id="outputBox" class="output-box">
                <!-- Musical output appears here -->
            </div>
        </div>
    </div>
    
    <script>
        // VERSION 1.1 - MUSICAL OUTPUT
        console.log('MRProfiles FretboardKit v1.1 Musical loaded successfully');
        
        // Musical Profile Database with actual note values
        const profiles = {
            'wes-montgomery': {
                name: 'Wes Montgomery',
                description: 'Thumb Octaves/Chord Solos',
                tuning: [40, 45, 50, 55, 59, 64], // E2, A2, D3, G3, B3, E4 (MIDI notes)
                patterns: [
                    { string: 5, fret: 3, duration: 0.25, velocity: 80 },
                    { string: 3, fret: 5, duration: 0.25, velocity: 80 },
                    { string: 5, fret: 5, duration: 0.25, velocity: 80 },
                    { string: 3, fret: 7, duration: 0.25, velocity: 80 }
                ],
                scale: 'blues',
                tempo: 120
            },
            'jim-hall': {
                name: 'Jim Hall',
                description: 'Sparse/Lyrical',
                tuning: [40, 45, 50, 55, 59, 64],
                patterns: [
                    { string: 2, fret: 5, duration: 0.5, velocity: 60 },
                    { string: 2, fret: 7, duration: 0.5, velocity: 60 },
                    { string: 1, fret: 5, duration: 0.5, velocity: 60 },
                    { string: 0, fret: 6, duration: 0.5, velocity: 60 }
                ],
                scale: 'lydian',
                tempo: 100
            },
            'joe-pass': {
                name: 'Joe Pass',
                description: 'Chord-Melody',
                tuning: [40, 45, 50, 55, 59, 64],
                patterns: [
                    { string: 5, fret: 3, duration: 0.125, velocity: 70 },
                    { string: 5, fret: 5, duration: 0.125, velocity: 70 },
                    { string: 4, fret: 5, duration: 0.125, velocity: 70 },
                    { string: 4, fret: 7, duration: 0.125, velocity: 70 }
                ],
                scale: 'bebop',
                tempo: 140
            },
            'rebetiko': {
                name: 'Greek Rebetiko',
                description: 'Koupes rhythm patterns',
                tuning: [40, 45, 50, 55, 59, 64],
                patterns: [
                    { string: 5, fret: 0, duration: 0.25, velocity: 90 },
                    { string: 4, fret: 2, duration: 0.125, velocity: 70 },
                    { string: 5, fret: 0, duration: 0.125, velocity: 90 },
                    { string: 3, fret: 0, duration: 0.25, velocity: 80 },
                    { string: 4, fret: 1, duration: 0.25, velocity: 70 }
                ],
                scale: 'byzantine',
                tempo: 110
            },
            'tsitsanis': {
                name: 'Vassilis Tsitsanis',
                description: 'Greek master',
                tuning: [40, 45, 50, 55, 59, 64],
                patterns: [
                    { string: 5, fret: 0, duration: 0.25, velocity: 85 },
                    { string: 5, fret: 1, duration: 0.25, velocity: 75 },
                    { string: 5, fret: 4, duration: 0.25, velocity: 75 },
                    { string: 4, fret: 2, duration: 0.25, velocity: 80 }
                ],
                scale: 'hijaz',
                tempo: 100
            },
            'sonic-youth': {
                name: 'Sonic Youth',
                description: 'Custom tunings - CGDGCD',
                tuning: [36, 43, 50, 55, 48, 50], // Custom tuning
                patterns: [
                    { string: 5, fret: 0, duration: 0.5, velocity: 95 },
                    { string: 4, fret: 0, duration: 0.5, velocity: 95 },
                    { string: 3, fret: 0, duration: 0.5, velocity: 95 },
                    { string: 2, fret: 3, duration: 0.5, velocity: 95 }
                ],
                scale: 'experimental',
                tempo: 135
            },
            'joni-mitchell': {
                name: 'Joni Mitchell',
                description: 'Open D tuning',
                tuning: [38, 45, 50, 54, 57, 62], // DADF#AD
                patterns: [
                    { string: 5, fret: 0, duration: 0.5, velocity: 65 },
                    { string: 4, fret: 0, duration: 0.25, velocity: 60 },
                    { string: 3, fret: 0, duration: 0.25, velocity: 60 },
                    { string: 2, fret: 0, duration: 0.5, velocity: 65 }
                ],
                scale: 'modal',
                tempo: 90
            },
            'travis-picking': {
                name: 'Travis Picking',
                description: 'Alternating bass',
                tuning: [40, 45, 50, 55, 59, 64],
                patterns: [
                    { string: 5, fret: 0, duration: 0.25, velocity: 80 },
                    { string: 3, fret: 2, duration: 0.25, velocity: 60 },
                    { string: 4, fret: 2, duration: 0.25, velocity: 75 },
                    { string: 3, fret: 2, duration: 0.25, velocity: 60 }
                ],
                scale: 'major',
                tempo: 110
            },
            'boom-chuck': {
                name: 'Boom-Chuck',
                description: 'Bluegrass rhythm',
                tuning: [40, 45, 50, 55, 59, 64],
                patterns: [
                    { string: 5, fret: 3, duration: 0.25, velocity: 90 },
                    { string: 3, fret: 0, duration: 0.125, velocity: 70 },
                    { string: 2, fret: 0, duration: 0.125, velocity: 70 },
                    { string: 1, fret: 0, duration: 0.125, velocity: 70 }
                ],
                scale: 'pentatonic',
                tempo: 160
            }
        };
        
        let currentProfile = null;
        let audioContext = null;
        let isPlaying = false;
        let currentNotes = [];
        
        // Initialize Web Audio API
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }
        
        // Convert pattern to MIDI notes
        function patternToMIDI(profile, transpose = 0) {
            const midiNotes = [];
            profile.patterns.forEach(note => {
                const midiNote = profile.tuning[note.string] + note.fret + transpose;
                midiNotes.push({
                    pitch: midiNote,
                    duration: note.duration,
                    velocity: note.velocity,
                    time: midiNotes.length > 0 ? 
                        midiNotes[midiNotes.length - 1].time + midiNotes[midiNotes.length - 1].duration : 0
                });
            });
            return midiNotes;
        }
        
        // Generate MusicXML
        function generateMusicXML(profile, transpose = 0) {
            const midiNotes = patternToMIDI(profile, transpose);
            const tempo = document.getElementById('tempo').value;
            
            let musicXML = `<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE score-partwise PUBLIC "-//Recordare//DTD MusicXML 3.1 Partwise//EN" "http://www.musicxml.org/dtds/partwise.dtd">
<score-partwise version="3.1">
  <part-list>
    <score-part id="P1">
      <part-name>${profile.name}</part-name>
    </score-part>
  </part-list>
  <part id="P1">
    <measure number="1">
      <attributes>
        <divisions>4</divisions>
        <time>
          <beats>4</beats>
          <beat-type>4</beat-type>
        </time>
        <clef>
          <sign>G</sign>
          <line>2</line>
        </clef>
      </attributes>
      <direction placement="above">
        <direction-type>
          <metronome>
            <beat-unit>quarter</beat-unit>
            <per-minute>${tempo}</per-minute>
          </metronome>
        </direction-type>
      </direction>`;
            
            midiNotes.forEach(note => {
                const pitchName = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'][note.pitch % 12];
                const octave = Math.floor(note.pitch / 12) - 1;
                const duration = Math.round(note.duration * 4);
                
                musicXML += `
      <note>
        <pitch>
          <step>${pitchName.replace('#', '')}</step>
          ${pitchName.includes('#') ? '<alter>1</alter>' : ''}
          <octave>${octave}</octave>
        </pitch>
        <duration>${duration}</duration>
        <type>${duration === 4 ? 'quarter' : duration === 2 ? 'eighth' : 'sixteenth'}</type>
      </note>`;
            });
            
            musicXML += `
    </measure>
  </part>
</score-partwise>`;
            
            return musicXML;
        }
        
        // Generate MIDI file data
        function generateMIDI(profile, transpose = 0) {
            const midiNotes = patternToMIDI(profile, transpose);
            const tempo = document.getElementById('tempo').value;
            
            // Simplified MIDI format (Type 0)
            let midiData = 'MThd\x00\x00\x00\x06\x00\x00\x00\x01\x00\x60'; // Header
            midiData += 'MTrk'; // Track header
            
            let trackData = '';
            let currentTime = 0;
            
            // Set tempo
            trackData += '\x00\xFF\x51\x03' + String.fromCharCode(
                (60000000 / tempo) >> 16,
                ((60000000 / tempo) >> 8) & 0xFF,
                (60000000 / tempo) & 0xFF
            );
            
            // Add notes
            midiNotes.forEach(note => {
                const deltaTime = Math.round((note.time - currentTime) * 96);
                trackData += String.fromCharCode(deltaTime);
                trackData += '\x90' + String.fromCharCode(note.pitch, note.velocity); // Note on
                trackData += String.fromCharCode(Math.round(note.duration * 96));
                trackData += '\x80' + String.fromCharCode(note.pitch, 0); // Note off
                currentTime = note.time + note.duration;
            });
            
            // End of track
            trackData += '\x00\xFF\x2F\x00';
            
            // Add track length
            const trackLength = trackData.length;
            midiData += String.fromCharCode(
                (trackLength >> 24) & 0xFF,
                (trackLength >> 16) & 0xFF,
                (trackLength >> 8) & 0xFF,
                trackLength & 0xFF
            );
            midiData += trackData;
            
            return btoa(midiData);
        }
        
        // Play pattern using Web Audio API
        function playPattern() {
            if (!currentProfile) {
                alert('Please select a profile first');
                return;
            }
            
            initAudio();
            isPlaying = true;
            
            const transpose = parseInt(document.getElementById('keySelect').value);
            const tempo = parseInt(document.getElementById('tempo').value);
            const midiNotes = patternToMIDI(currentProfile, transpose);
            
            // Play each note
            midiNotes.forEach(note => {
                const startTime = audioContext.currentTime + (note.time * 60 / tempo);
                playNote(note.pitch, startTime, note.duration * 60 / tempo, note.velocity / 127);
            });
        }
        
        // Play a single note
        function playNote(midiNote, startTime, duration, velocity) {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            const frequency = 440 * Math.pow(2, (midiNote - 69) / 12);
            oscillator.frequency.value = frequency;
            oscillator.type = 'triangle'; // Softer sound
            
            gainNode.gain.setValueAtTime(0, startTime);
            gainNode.gain.linearRampToValueAtTime(velocity * 0.3, startTime + 0.01);
            gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + duration);
            
            oscillator.start(startTime);
            oscillator.stop(startTime + duration);
        }
        
        // Initialize fretboard
        function initFretboard() {
            const svg = document.getElementById('fretboard');
            svg.innerHTML = ''; // Clear
            
            // Draw strings
            for (let i = 0; i < 6; i++) {
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', '50');
                line.setAttribute('y1', 30 + i * 40);
                line.setAttribute('x2', '950');
                line.setAttribute('y2', 30 + i * 40);
                line.setAttribute('stroke', '#333');
                line.setAttribute('stroke-width', '2');
                svg.appendChild(line);
            }
            
            // Draw frets
            for (let i = 0; i <= 12; i++) {
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', 50 + i * 75);
                line.setAttribute('y1', '30');
                line.setAttribute('x2', 50 + i * 75);
                line.setAttribute('y2', '230');
                line.setAttribute('stroke', i === 0 ? '#000' : '#999');
                line.setAttribute('stroke-width', i === 0 ? '4' : '2');
                svg.appendChild(line);
            }
            
            // Add fret markers
            const markers = [3, 5, 7, 9, 12];
            markers.forEach(fret => {
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', 50 + (fret - 0.5) * 75);
                circle.setAttribute('cy', '130');
                circle.setAttribute('r', '6');
                circle.setAttribute('fill', '#ddd');
                svg.appendChild(circle);
            });
        }
        
        // Draw pattern on fretboard
        function drawPattern(patterns) {
            const svg = document.getElementById('fretboard');
            // Remove old notes
            svg.querySelectorAll('.note').forEach(el => el.remove());
            
            patterns.forEach((note, index) => {
                setTimeout(() => {
                    // Add visual feedback when playing
                    const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    circle.setAttribute('class', 'note');
                    circle.setAttribute('cx', 50 + (note.fret === 0 ? -25 : (note.fret - 0.5) * 75));
                    circle.setAttribute('cy', 30 + note.string * 40);
                    circle.setAttribute('r', '15');
                    circle.setAttribute('fill', isPlaying ? '#28a745' : '#667eea');
                    circle.setAttribute('stroke', '#fff');
                    circle.setAttribute('stroke-width', '2');
                    svg.appendChild(circle);
                    
                    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    text.setAttribute('class', 'note');
                    text.setAttribute('x', 50 + (note.fret === 0 ? -25 : (note.fret - 0.5) * 75));
                    text.setAttribute('y', 35 + note.string * 40);
                    text.setAttribute('text-anchor', 'middle');
                    text.setAttribute('fill', '#fff');
                    text.setAttribute('font-size', '12');
                    text.setAttribute('font-weight', 'bold');
                    text.textContent = note.fret.toString();
                    svg.appendChild(text);
                }, index * 100);
            });
        }
        
        // Event Listeners
        document.getElementById('profileSelect').addEventListener('change', function(e) {
            const profileId = e.target.value;
            if (profileId && profiles[profileId]) {
                currentProfile = profiles[profileId];
                document.getElementById('profileName').textContent = currentProfile.name;
                document.getElementById('profileInfo').innerHTML = `
                    <h4>${currentProfile.name}</h4>
                    <p>${currentProfile.description}</p>
                    <p>Scale: ${currentProfile.scale}</p>
                    <p>Suggested Tempo: ${currentProfile.tempo} BPM</p>
                `;
                document.getElementById('tempo').value = currentProfile.tempo;
                document.getElementById('tempoValue').textContent = currentProfile.tempo + ' BPM';
                drawPattern(currentProfile.patterns);
            }
        });
        
        document.getElementById('tempo').addEventListener('input', function(e) {
            document.getElementById('tempoValue').textContent = e.target.value + ' BPM';
        });
        
        document.getElementById('playPattern').addEventListener('click', playPattern);
        
        document.getElementById('stopPattern').addEventListener('click', function() {
            isPlaying = false;
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }
        });
        
        document.getElementById('exportMusicXML').addEventListener('click', function() {
            if (!currentProfile) {
                alert('Please select a profile first');
                return;
            }
            const transpose = parseInt(document.getElementById('keySelect').value);
            const musicXML = generateMusicXML(currentProfile, transpose);
            
            // Create download
            const blob = new Blob([musicXML], {type: 'text/xml'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentProfile.name}.musicxml`;
            a.click();
            
            // Show in output
            document.getElementById('outputBox').textContent = musicXML;
            document.getElementById('outputBox').classList.add('visible');
        });
        
        document.getElementById('exportMIDI').addEventListener('click', function() {
            if (!currentProfile) {
                alert('Please select a profile first');
                return;
            }
            const transpose = parseInt(document.getElementById('keySelect').value);
            const midiData = generateMIDI(currentProfile, transpose);
            
            // Create download
            const blob = new Blob([atob(midiData)], {type: 'audio/midi'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentProfile.name}.mid`;
            a.click();
            
            document.getElementById('outputBox').textContent = `MIDI file exported: ${currentProfile.name}.mid`;
            document.getElementById('outputBox').classList.add('visible');
        });
        
        document.getElementById('exportAudio').addEventListener('click', function() {
            if (!currentProfile) {
                alert('Please select a profile first');
                return;
            }
            alert('WAV export requires additional libraries. Use MusicXML or MIDI for now.');
        });
        
        document.getElementById('exportRiffGen').addEventListener('click', function() {
            if (!currentProfile) {
                alert('Please select a profile first');
                return;
            }
            const output = `// RiffGen Musical Pattern: ${currentProfile.name}
const pattern = ${JSON.stringify(currentProfile, null, 2)};

// This includes actual MIDI notes, durations, and velocities
// Copy to RiffGen.html for musical generation`;
            
            // Copy to clipboard
            const textarea = document.createElement('textarea');
            textarea.value = output;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            
            document.getElementById('outputBox').textContent = output;
            document.getElementById('outputBox').classList.add('visible');
            alert('Musical pattern copied to clipboard!');
        });
        
        // Initialize on load
        window.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing musical fretboard...');
            initFretboard();
        });
    </script>
</body>
</html>