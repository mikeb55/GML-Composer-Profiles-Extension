<!DOCTYPE html>
<html>
<head>
    <title>MIDI Player - Fixed Stop</title>
    <script src="https://unpkg.com/tone@14.7.77/build/Tone.js"></script>
    <script src="https://unpkg.com/@tonejs/midi@2.0.28/build/Midi.js"></script>
    <style>
        body { background: #1a1a1a; color: white; font-family: Arial; padding: 20px; }
        button { padding: 10px 20px; margin: 5px; font-size: 16px; cursor: pointer; }
        button:disabled { background: #666; cursor: not-allowed; }
        #info { background: #333; padding: 15px; margin: 20px 0; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>ðŸŽµ MIDI Player - Stop Fixed</h1>
    
    <button onclick="loadFile()">Load MIDI</button>
    <button onclick="playMidi()" id="playBtn" disabled>Play</button>
    <button onclick="stopMidi()" id="stopBtn">Stop</button>
    <input type="file" id="fileInput" accept=".mid" style="display:none" onchange="handleFile(this.files[0])">
    
    <div id="info"></div>
    <div id="status">Load a MIDI file</div>
    
    <script>
    let midiFile = null;
    let synth = null;
    let part = null;  // Tone.Part for scheduling
    let stopTimeout = null;  // Timeout reference
    
    function loadFile() {
        document.getElementById('fileInput').click();
    }
    
    async function handleFile(file) {
        if (!file) return;
        
        const buffer = await file.arrayBuffer();
        midiFile = new Midi(buffer);
        
        const totalNotes = midiFile.tracks.reduce((sum, t) => sum + t.notes.length, 0);
        document.getElementById('info').innerHTML = `
            Loaded: ${file.name}<br>
            Tracks: ${midiFile.tracks.length}<br>
            Notes: ${totalNotes}<br>
            Duration: ${midiFile.duration?.toFixed(2) || 0}s
        `;
        
        document.getElementById('playBtn').disabled = false;
        document.getElementById('status').innerText = 'Ready to play';
    }
    
    async function playMidi() {
        if (!midiFile) return;
        
        // Initialize audio
        await Tone.start();
        
        // Stop any current playback first
        stopMidi();
        
        // Create synth
        synth = new Tone.PolySynth().toDestination();
        synth.volume.value = -10;
        
        // Collect all notes
        const allNotes = [];
        midiFile.tracks.forEach(track => {
            track.notes.forEach(note => {
                allNotes.push({
                    time: note.time,
                    note: note.name,
                    duration: note.duration,
                    velocity: note.velocity || 0.8
                });
            });
        });
        
        if (allNotes.length === 0) {
            document.getElementById('status').innerText = 'No notes to play!';
            return;
        }
        
        // Create Tone.Part for proper scheduling
        part = new Tone.Part((time, note) => {
            synth.triggerAttackRelease(
                note.note,
                note.duration,
                time,
                note.velocity
            );
        }, allNotes);
        
        // Start playback
        Tone.Transport.start();
        part.start(0);
        
        document.getElementById('status').innerText = 'Playing...';
        document.getElementById('playBtn').disabled = true;
        
        // Auto-stop after duration
        if (midiFile.duration) {
            stopTimeout = setTimeout(() => {
                stopMidi();
                document.getElementById('status').innerText = 'Finished';
            }, midiFile.duration * 1000 + 500);
        }
    }
    
    function stopMidi() {
        // Clear timeout
        if (stopTimeout) {
            clearTimeout(stopTimeout);
            stopTimeout = null;
        }
        
        // Stop transport
        Tone.Transport.stop();
        Tone.Transport.cancel();  // Cancel all scheduled events
        
        // Dispose of part
        if (part) {
            part.dispose();
            part = null;
        }
        
        // Release and dispose synth
        if (synth) {
            synth.releaseAll();
            synth.dispose();
            synth = null;
        }
        
        // Reset UI
        document.getElementById('playBtn').disabled = midiFile === null;
        document.getElementById('status').innerText = 'Stopped';
    }
    
    // Test button
    async function testAudio() {
        await Tone.start();
        const testSynth = new Tone.Synth().toDestination();
        testSynth.triggerAttackRelease("C4", "8n");
        setTimeout(() => testSynth.dispose(), 1000);
    }
    </script>
    
    <button onclick="testAudio()">Test Audio</button>
</body>
</html>
